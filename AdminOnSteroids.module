<?php

/**
 * AdminOnSteroids
 * Various admin tweaks
 *
 * @author Roland Toth (tpr)
 *
 * ProcessWire 3.x
 * Copyright (C) 2011 by Ryan Cramer
 * Licensed under GNU/GPL v2, see LICENSE.TXT
 *
 * http://www.processwire.com
 * http://www.ryancramer.com
 *
 */
class AdminOnSteroids extends WireData implements Module, ConfigurableModule {

    static $configData;
    public $pageListThumbSettings;
    protected $editedPage;

    public static function getModuleInfo() {
        return array(
            'title'     => 'AdminOnSteroids',
            'class'     => 'AdminOnSteroids',
            'version'   => 40,
            'summary'   => __('Various admin tweaks'),
            'author'    => 'Roland Toth',
            'autoload'  => 'template=admin',
            'href'      => 'https://processwire.com/talk/topic/13389-adminonsteroids/',
            'icon'      => 'medkit',
            'requires'  => 'ProcessWire>=2.8.0, PHP>=5.3.8',
            'singular'  => true,
            'permanent' => false
        );
    }

    /**
     * Default configuration for module
     *
     */
    static public function getDefaultData() {
        return array(
            'enabledSubmodules'            => array(
                'AutosizeTextareas',
                'AsmTweaks',
                'DeselectRadios',
                'NoAnims',
                'FileFieldToolbar',
                'FieldEditLinks',
                'FocusInputOnLangTabSwitch',
                'LangTabHotkeySwitcher',
                'AdminTweaks',
                'RenoTweaks',
                'LongClickDuration',
                'HoverSaveDropdown',
                'Hotkeys',
                'InputfieldURLChecker',
                'PageListThumbs',
                'PagePreviewLink',
                'ModuleTweaks',
                'Tooltips',
                'TabIndex',
                'fixScrollbarJump'
            ),
            'DeselectRadios'               => array(
                'adminOnly'
            ),
            'AsmTweaks'                    => array(
                'collapseAsmSections',
                'leftAsmDelete'
            ),
            'FileFieldToolbar'             => array(
                'filterbox'
            ),
            'FocusInputOnLangTabSwitch'    => array(
                'focus'
            ),
            'ModuleTweaks'                 => array(
                'loadCollapsedModuleInfos',
                'compactModuleList'
            ),
            'Hotkeys'                      => array(
                'save',
                'breadcrumbTweaks'
            ),
            'Tooltips'                     => array(
                'superuseronly',
                'description',
                'notes'
//                'overlayStyle'
            ),
            'InputfieldURLChecker'         => array(
                'IUC_mode'              => array(
                    'button'
                ),
                'IUC_button_position'   => 'button-left',
                'IUC_target'            => 'pw-blank',
                'IUC_force_http'        => 1,
                'IUC_enabled_templates' => array(),
                'IUC_enabled_fields'    => array()
            ),
            'FocusInputOnLangTabSwitchCKE' => array(
                'focus'
            ),
            'PagePreviewLink'              => array(
                'pw-blank'
            ),
            'FieldEditLinks'               => array(
                'pw-blank'
            ),
            'PageListThumbs'               => array(
                'PageListThumbStyle' => 'circle'
            ),
            'LongClickDuration'            => 600,
            'RenoTweaks'                   => array(
                'singleClickSidebarHeaders',
                'stickyHeader',
                'stickyHeaderCompact',
                'miniScrollbarSidebar',
//                'miniScrollbarMain',
                'stickySidebar',
                'stickyCKEditorToolbar',
//                'autoHideSidebar',
                'alwaysVisibleSidebarItems',
//                'hideSidebarQuickLinks',
//                'oneLineSidebarSubmenus',
                'headButtonNextToTitle',
                'alwaysShowSearch',
                'compactPageList',
                'closeNoticeButtonToLeft'
            ),
            'AdminTweaks'                  => array(
                'stickyHeader'
            )
        );
    }

    public function __toString() {
        return __CLASS__;
    }

    public function ___install() {
        // apply default module settings on install
        $this->wire('modules')->saveModuleConfigData($this, self::getDefaultData());
    }


//    public function addCSS(HookEvent $event) {
//
//        $css = file_get_contents(__DIR__ . '/AdminOnSteroids.css');
//
//        $event->return = str_replace('</head>', '<style>' . $css . '</style>' . '</head>', $event->return);
//    }
//    public function replaceCSS(HookEvent $event) {
//        $event->return = str_replace('/wire/modules/AdminTheme/AdminThemeReno/styles/main.css', '/site/modules/AdminOnSteroids/AdminOnSteroids.css', $event->return);
//    }
    public function addLoader(HookEvent $event) {

        $img = 'data:image/gif;base64,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';

        $aos_loader = <<< HTML
 <style id="aos_loader">
    body {visibility: hidden; overflow: hidden; background: url($img) center 47% no-repeat;"}
</style>
<script>
window.addEventListener('DOMContentLoaded', function() {
    document.head.removeChild(document.querySelector('#aos_loader'));
});
</script>
HTML;

        $event->return = str_replace('</head>', $aos_loader . PHP_EOL . '</head>', $event->return);
    }


    public function ready() {

        self::$configData = $this->modules->getModuleConfigData($this);

        $configData = self::$configData;

        $defaultData = self::getDefaultData();
        $this->pageListThumbSettings = array();


        if (!isset($configData['enabledSubmodules'])) {
            return;
        }

        $enabledSubmodules = $configData['enabledSubmodules'];

        $editedPageId = $this->sanitizer->int($this->config->input->get->id);

        if (!empty($editedPageId) && is_numeric($editedPageId) && $this->pages->get($editedPageId)) {
            $this->editedPage = $this->pages->get($editedPageId);
        } else {
            $this->editedPage = null;
        }

        $this->addHookAfter('Page::render', $this, 'addLoader');
//        $this->addHookAfter('Page::render', $this, 'replaceCSS');
//        $this->addHookAfter('Page::render', $this, 'addCSS');

        $root = $this->config->urls->siteModules . __CLASS__;
        $styles = $this->config->styles;
        $scripts = $this->config->scripts;


        //AutosizeTextareas
        $subModule = 'AutosizeTextareas';
        if (in_array($subModule, $enabledSubmodules)) {
            $scripts->add($root . '/' . $subModule . '/Autosize.js');
            $scripts->add($root . '/' . $subModule . '/' . $subModule . '.js');
        }

        //FieldEditLinks
        $subModule = 'FieldEditLinks';
        if (in_array($subModule, $enabledSubmodules)) {

            if ($this->user->hasRole('superuser') && !is_null($this->editedPage)) {

                // add edit field link only if the edited page is not a special page (eg. admin)
                if ($this->editedPage->template && $this->editedPage->template->flags === 0) {
                    $this->addHookAfter('Inputfield::renderValue', $this, 'addFieldEditLinks');
                    $this->addHookAfter('Inputfield::render', $this, 'addFieldEditLinks');
                }
            }
        }

        //DeselectRadios
        $subModule = 'DeselectRadios';
        if (in_array($subModule, $enabledSubmodules)) {
            if (!in_array('adminOnly', $configData['DeselectRadios']) || $this->wire('user')->isSuperUser()) {
                $scripts->add($root . '/' . $subModule . '/' . $subModule . '.js');
            }
        }


        //InputfieldURLChecker
        $subModule = 'InputfieldURLChecker';
        if (in_array($subModule, $enabledSubmodules)) {

            $scripts->add($root . '/' . $subModule . '/' . $subModule . '.js');
            $styles->add($root . '/' . $subModule . '/' . $subModule . '.css');

            $this->addHookAfter('InputfieldURL::renderValue', $this, 'addIUCLink');
            $this->addHookAfter('InputfieldURL::render', $this, 'addIUCLink');
        }


        //AsmTweaks
        $subModule = 'AsmTweaks';
        if (in_array($subModule, $enabledSubmodules)) {
            $scripts->add($root . '/' . $subModule . '/' . $subModule . '.js');
        }

        //RenoTweaks
        $subModule = 'RenoTweaks';
        if (in_array($subModule, $enabledSubmodules)) {
            if (in_array('stickyHeader', $configData[$subModule])) {
                if (in_array('miniScrollbarSidebar', $configData[$subModule]) || in_array('miniScrollbarMain', $configData[$subModule])) {
                    $scripts->add($root . '/lib/perfect-scrollbar/js/perfect-scrollbar.min.js');
                }
            }
        }

        //FocusInputOnLangTabSwitch
        $subModule = 'FocusInputOnLangTabSwitch';
        if (in_array($subModule, $enabledSubmodules)) {
            $scripts->add($root . '/' . $subModule . '/' . $subModule . '.js');
        }

        //Hotkeys
        $subModule = 'Hotkeys';
        if (in_array($subModule, $enabledSubmodules)) {

            // add breadcrumb tweaks
            if (in_array('breadcrumbTweaks', $configData[$subModule])) {

                $page = $this->pages->get('has_parent!=2, id=' . $this->input->get->id);

                if ($page->id) {
                    $homepage = $this->wire->pages->get(1);
                    $breadcrumbUrls = array();

                    foreach ($this->wire->pages->get(1)->and($page->parentsUntil(1)) as $p) {
                        $breadcrumbUrls[] = array(
                            'url'     => $p->viewable() ? $p->httpUrl : null,
                            'editUrl' => $p->editable() ? rtrim($homepage->httpUrl, '/') . $p->editUrl : null
                        );
                    }

                    // add to js config (head)
                    $this->config->js("AOS_breadcrumbs", $breadcrumbUrls);
                }
            }

            $scripts->add($root . '/' . $subModule . '/' . $subModule . '.js');
        }

        //LangTabHotkeySwitcher
        $subModule = 'LangTabHotkeySwitcher';
        if (in_array($subModule, $enabledSubmodules)) {
            $scripts->add($root . '/' . $subModule . '/' . $subModule . '.js');
        }

        //LongClickDuration
        $subModule = 'LongClickDuration';
        if (in_array($subModule, $enabledSubmodules)) {

            $LongClickDuration = (int)$configData['LongClickDuration'];

            //do not allow lower value than default 600
            $LongClickDuration = ($LongClickDuration < $defaultData['LongClickDuration']) ? $defaultData['LongClickDuration'] : $LongClickDuration;

            $configSettings['LongClickDuration'] = $LongClickDuration;
        } else {
            // need to set default value explicitly
            $configSettings['LongClickDuration'] = $defaultData['LongClickDuration'];
        }

        $styles->prepend($root . '/' . __CLASS__ . '.css');

        // also add global JS
        $scripts->add($root . '/' . __CLASS__ . '.js');

        // remove Tooltips if it's superuser only and user is not superuser
        if (isset($configData['Tooltips']) && (in_array('superuseronly', $configData['Tooltips']) && !$this->user->isSuperUser())) {
            // delete from array by value
            if (($key = array_search('Tooltips', $enabledSubmodules)) !== false) {
                $configData['enabledSubmodules'][$key] = 'Tooltips_disabled';
                unset($configData['Tooltips']);
                // note: unset didn't work (because there will be a hole in keys?)
//                unset($configData['enabledSubmodules'][$key]);
            }
        }

        $subModule = 'ModuleTweaks';
        if (in_array($subModule, $enabledSubmodules)) {

            if (in_array('loadCollapsedModuleInfos', $configData[$subModule])) {
                // Load module info fields collapsed
                $this->addHookAfter('InputfieldMarkup::render', function ($event) {
                    $field = $event->object;
                    if ($field->id == 'ModuleInfo') {
                        $field->addClass('InputfieldStateCollapsed');
                    }
                });
            }
        }

        $subModule = 'PageListThumbs';
        if (in_array($subModule, $enabledSubmodules)) {
            $this->addHookAfter('ProcessPageListRender::getPageLabel', $this, 'addPageListThumb');
        }

        // note: $configSettings overwrite $configData (intentional)
//        $this->config->js("AdminOnSteroids", json_encode(array_merge($configData, $configSettings)));
        $this->config->js("AdminOnSteroids", json_encode($configData));
    }

    public function getFormattedOptionName($obj) {
        return !empty($obj->label) ? $obj->label . ' (' . $obj->name . ')' : $obj->name;
    }


    public function addFieldEditLinks(HookEvent $event) {

        $inputfield = $event->object;

        if ($inputfield->type == 'hidden') {
            return;
        }
        if (strpos($event->return, 'data-editurl')) {
            return;
        }


        if ($field = $this->fields->get($inputfield->name)) {

            $editUrl = $this->config->urls->admin . 'setup/field/edit?id=' . $field->id;

            // needed to allow HTML in label
            $inputfield->entityEncodeLabel = false;
            $inputfield->label = $inputfield->label . ' <span class="aos_field_name">' . $inputfield->name . '</span>';
//            $inputfield->label = $inputfield->label . '::aos_field_name::' . $inputfield->name;

            // use hidden link to be able to use modal/panel
            // note: link is not added to the label tag because it won't be clickable
            $target = isset(self::$configData['FieldEditLinks']) ? self::$configData['FieldEditLinks'] : '';

            $inputfield->appendMarkup = '<a href="' . $editUrl . '" class="' . $target . ' aos_editurl" target="_blank" style="display: none !important;">Edit</a>';
        }
    }

    public function addIUCLink(HookEvent $event) {

        $inputfield = $event->object;
        $url = $inputfield->value ? $inputfield->value : '';
        $configData = $this->modules->getModuleConfigData($this);
        $editedPage = $this->editedPage;
        $editLinkAttrsArray = array();
        $editLinkAttrs = '';

        if (!empty($configData['IUC_enabled_templates']) && !in_array($editedPage->template->name, $configData['IUC_enabled_templates'])) {
            return false;
        }

        if (!empty($configData['IUC_enabled_fields']) && !in_array($inputfield->name, $configData['IUC_enabled_fields'])) {
            return false;
        }

        // process locked fields
        if (in_array($inputfield->collapsed, array(7, 8))) {
            $target = isset($configData['IUC_target']) ? $configData['IUC_target'] : '';
            $event->return = '<a href="' . $event->return . '" target="_blank" class="iuc iuc-locked-link ' . $target . '">' . $event->return . '</a>';

            return true;
        }


        if (isset($configData['IUC_mode'])) {

            $mode = implode(',', $configData['IUC_mode']);

            $editLinkAttrsArray['data-iuc-mode'][] = $mode;

            if (in_array('button', $configData['IUC_mode'])) {
                $buttonPosition = isset($configData['IUC_button_position']) ? $configData['IUC_button_position'] : '';
                $editLinkAttrsArray['class'][] = 'iuc iuc-button ' . $buttonPosition;
            } else {
                $editLinkAttrsArray['class'][] = 'iuc iuc-hidden';
            }
        }

        if (isset($configData['IUC_target'])) {
            $editLinkAttrsArray['class'][] = $configData['IUC_target'];
        }

        if (isset($configData['IUC_force_http']) && $configData['IUC_force_http'] == 1) {
            $editLinkAttrsArray['data-iuc-force-http'][] = 1;
        }

        foreach ($editLinkAttrsArray as $attr_name => $values) {
            $editLinkAttrs .= $attr_name . '="' . implode(' ', $values) . '" ';
        }

        $editLinkMarkup = '<a href="' . $url . '"' . $editLinkAttrs . ' target="_blank"><i class="fa fa-arrow-right"></i></a>';

        $inputfield->prependMarkup = $editLinkMarkup;

        return false;
    }


    public function addPageListThumb(HookEvent $event) {

        $page = $event->arguments('page');
        $field = null;

        // intentional =
        if (!($settings = $this->getPageThumbSettings())) {
            return false;
        }

        // only one field name is passed (global)
        if (count($settings) == 1 && strpos($settings[0], ':') === false) {

            $field = $settings[0];

        } else {

            // multiple lines of settings passed
            foreach ($settings as $pairs) {

                if (strpos($pairs, '//') === 0) {
                    continue;
                }

                $setting = explode(':', $pairs);

                $f = isset($setting[0]) ? trim($setting[0]) : null;
                $selector = isset($setting[1]) ? trim($setting[1]) : null;

                if (is_null($f) || !$page->$f || !($page->$f instanceof Pageimage)) {
                    continue;
                }


                if (is_null($selector)) {
                    // break if there's no selector (any page will match)
                    $field = $f;
                    break;

                } elseif ($page->is($selector)) {
                    // break if page matches
                    $field = $f;
                    break;
                }
            }
        }

        if (!is_null($field)) {

            // set thumbnail style class
            $class = (isset($this->PageListThumbStyle) && !empty($this->PageListThumbStyle)) ? ' class="' . $this->PageListThumbStyle . '"' : '';
            $thumbSize = ($this->RenoTweaks && in_array('compactPageList', $this->RenoTweaks)) ? 32 : 48;

            if ($this->PageListThumbStyle === 'square') {
                $thumbSrc = $page->$field->size($thumbSize, $thumbSize, array('cropping' => false))->url;
            } else {
                $thumbSrc = $page->$field->height($thumbSize)->url;
            }

            $event->return = '<em' . $class . '><img src="' . $thumbSrc . '" /></em>' . $event->return;
        }

        return true;
    }


    public function getPageThumbSettings() {

        if ($this->pageListThumbSettings) {
            return $this->pageListThumbSettings;
        }

        $thumbSettings = isset($this->data['PageListThumbSettings']) ? $this->data['PageListThumbSettings'] : null;

        if (is_null($thumbSettings)) {
            return false;
        }

        // build settings array
        $settings = trim($thumbSettings);
        $settings = explode("\n", $settings);
        $settings = array_filter($settings, 'trim');

        $this->pageListThumbSettings = $settings;

        return $settings;
    }


    public function getModuleConfigInputfields(array $data) {

        $defaultData = self::getDefaultData();
        $data = array_merge(self::getDefaultData(), $data);

        $wrapper = new InputfieldWrapper();

        $f = wire('modules')->get("InputfieldCheckboxes");
        $f->attr('name', 'enabledSubmodules');
//        $f->columnWidth = 36;
        $f->label = __('Submodules', __FILE__);
        $f->description = __('Enable or disable submodules here.', __FILE__);
        $f->collapsed = Inputfield::collapsedNever;
//        $f->table = true;
//        $f->description = __('', __FILE__);
//        $f->notes = __('', __FILE__);

        $f->addOption('AdminTweaks', __('**AdminTweaks**Default admin theme tweaks', __FILE__));
        $f->addOption('AsmTweaks', __('**AsmTweaks**asmSelect tweaks', __FILE__));
        $f->addOption('AutosizeTextareas', __('**AutosizeTextareas**Autosize textareas according to content', __FILE__));
        $f->addOption('DeselectRadios', __('**DeselectRadios**Enable clearing checked radio buttons', __FILE__));
        $f->addOption('FieldEditLinks', __('**FieldEditLinks**Edit fields by clicking on their labels', __FILE__));
        $f->addOption('FileFieldToolbar', __('**FileFieldToolbar**Add filter box and sort buttons to file/image fields', __FILE__));
        $f->addOption('fixScrollbarJump', __('**FixScrollbarJump**Prevent page jump when scrollbar appears', __FILE__));
        $f->addOption('FocusInputOnLangTabSwitch', __('**FocusInputOnLangTabSwitch**Focus input on switching language tabs', __FILE__));
        $f->addOption('Hotkeys', __('**Hotkeys**Hotkey tweaks', __FILE__));
        $f->addOption('HoverSaveDropdown', __('**HoverSaveDropdown**Show save dropdown on hover instead on click', __FILE__));
        $f->addOption('InputfieldURLChecker', __('**InputfieldURLChecker**Add button or hotkey to FieldtypeURL to check URL', __FILE__));
        $f->addOption('LangTabHotkeySwitcher', __('**LangTabHotkeySwitcher**Switch language tabs on ctrl+arrow keys', __FILE__));
        $f->addOption('LongClickDuration', __('**LongClickDuration**Custom long-click action duration', __FILE__));
        $f->addOption('ModuleTweaks', __('**ModuleTweaks**Module related tweaks', __FILE__));
        $f->addOption('NoAnims', __('**NoAnims**Disable all admin animations', __FILE__));
        $f->addOption('PageListThumbs', __('**PageListThumbs**Add pagelist thumbnails', __FILE__));
        $f->addOption('PagePreviewLink', __('**PagePreviewLink**Add preview link next to page title', __FILE__));
        $f->addOption('RenoTweaks', __('**RenoTweaks**Reno admin theme tweaks', __FILE__));
        $f->addOption('TabIndex', __('**TabIndex**Add sequential tabindex to fields', __FILE__));
        $f->addOption('Tooltips', __('**Tooltips**Hide field descriptions and notes to tooltips', __FILE__));

        $f->attr('value', isset($data['enabledSubmodules']) ? $data['enabledSubmodules'] : $defaultData['enabledSubmodules']);

        $wrapper->add($f);


        $fset = wire('modules')->get("InputfieldFieldset");
        $fset->attr('name', 'tweaks');
//        $fset->columnWidth = 64;
        $fset->label = __('Options for individual submodules', __FILE__);
        $fset->collapsed = Inputfield::collapsedNever;


        // AdminTweaks ----------------------------------------------- //

        $f = wire('modules')->get("InputfieldCheckboxes");
        $f->attr('name', 'AdminTweaks');
        $f->label = __('AdminTweaks', __FILE__);
        $f->showIf = 'enabledSubmodules=AdminTweaks';
        $f->collapsed = Inputfield::collapsedNever;

        $f->addOption('stickyHeader', __('Sticky header', __FILE__));

        if ($data['AdminTweaks']) {
            $f->attr('value', $data['AdminTweaks']);
        }

        $fset->add($f);

        // AsmTweaks ----------------------------------------------- //

        $f = wire('modules')->get("InputfieldCheckboxes");
        $f->attr('name', 'AsmTweaks');
        $f->showIf = 'enabledSubmodules=AsmTweaks';
        $f->collapsed = Inputfield::collapsedNever;
        $f->description = __('', __FILE__);
        $f->notes = __('', __FILE__);

        $f->addOption('collapseAsmSections', __('Collapse fieldset/tab items on double click', __FILE__));
        $f->addOption('leftAsmDelete', __('Move delete button to the left', __FILE__));

        if ($data['AsmTweaks']) {
            $f->attr('value', $data['AsmTweaks']);
        }

        $fset->add($f);

        // DeselectRadios ----------------------------------------------- //

        $f = wire('modules')->get("InputfieldCheckboxes");
        $f->attr('name', 'DeselectRadios');
        $f->collapsed = Inputfield::collapsedNever;
        $f->description = __('', __FILE__);
        $f->notes = __('', __FILE__);
        $f->showIf = 'enabledSubmodules=DeselectRadios';

        $f->addOption('adminOnly', __('Only for SuperUsers', __FILE__));
        $f->addOption('allowRequired', __('Allow also for required fields (not recommended)', __FILE__));

        $f->attr('value', isset($data['DeselectRadios']) ? $data['DeselectRadios'] : $defaultData['DeselectRadios']);

        $fset->add($f);

        // FieldEditLinks ----------------------------------------------- //

        $f = wire('modules')->get("InputfieldRadios");
        $f->attr('name', 'FieldEditLinks');
        $f->showIf = 'enabledSubmodules=FieldEditLinks';
        $f->collapsed = Inputfield::collapsedNever;

        $f->addOption('pw-blank', __('Open in new tab', __FILE__));
        $f->addOption('pw-panel', __('Open in panel', __FILE__));
        $f->addOption('pw-modal', __('Open in modal', __FILE__));

        if ($data['FieldEditLinks']) {
            $f->attr('value', $data['FieldEditLinks']);
        }

        $fset->add($f);

        // FileFieldToolbar ----------------------------------------------- //

        $f = wire('modules')->get("InputfieldCheckboxes");
        $f->attr('name', 'FileFieldToolbar');
        $f->showIf = 'enabledSubmodules=FileFieldToolbar';
        $f->collapsed = Inputfield::collapsedNever;
        $f->description = __('', __FILE__);
        $f->notes = __('', __FILE__);

        $f->addOption('filterbox', __('Filter box', __FILE__));

        if ($data['FileFieldToolbar']) {
            $f->attr('value', $data['FileFieldToolbar']);
        }

        $fset->add($f);

        // FocusInputOnLangTabSwitch ----------------------------------------------- //

        $f = wire('modules')->get("InputfieldRadios");
        $f->attr('name', 'FocusInputOnLangTabSwitch');
        $f->showIf = 'enabledSubmodules=FocusInputOnLangTabSwitch';
        $f->collapsed = Inputfield::collapsedNever;
        $f->description = __('', __FILE__);
        $f->notes = __('', __FILE__);


        $f->addOption('focus', __('Focus', __FILE__));
        $f->addOption('moveEnd', __('Move cursor to the end', __FILE__));
        $f->addOption('selectAll', __('Select all', __FILE__));
        $f->addOption('nothing', __('Do nothing', __FILE__));

        if ($data['FocusInputOnLangTabSwitch']) {
            $f->attr('value', $data['FocusInputOnLangTabSwitch']);
        }

        $fset->add($f);

        $f = wire('modules')->get("InputfieldRadios");
        $f->attr('name', 'FocusInputOnLangTabSwitchCKE');
        $f->label = __('FocusInputOnLangTabSwitch CKEditor', __FILE__);
        $f->showIf = 'enabledSubmodules=FocusInputOnLangTabSwitch';
        $f->collapsed = Inputfield::collapsedNever;
        $f->description = __('', __FILE__);
        $f->notes = __('', __FILE__);

        $f->addOption('focus', __('Focus', __FILE__));
        $f->addOption('moveEnd', __('Move cursor to the end', __FILE__));
        $f->addOption('selectAll', __('Select all', __FILE__));
        $f->addOption('nothing', __('Do nothing', __FILE__));

        if ($data['FocusInputOnLangTabSwitchCKE']) {
            $f->attr('value', $data['FocusInputOnLangTabSwitchCKE']);
        }

        $fset->add($f);

        // Hotkeys ----------------------------------------------- //

        $f = wire('modules')->get("InputfieldCheckboxes");
        $f->attr('name', 'Hotkeys');
        $f->showIf = 'enabledSubmodules=Hotkeys';
        $f->collapsed = Inputfield::collapsedNever;

        $f->addOption('save', __('Save on ctrl+s', __FILE__));
        $f->addOption('breadcrumbTweaks', __('Add long-click and ctrl+click actions to breadcrumbs', __FILE__));

        if ($data['Hotkeys']) {
            $f->attr('value', $data['Hotkeys']);
        }

        $fset->add($f);

        // InputfieldURLChecker ----------------------------------------------- //

        $dataIUC = $data['InputfieldURLChecker'];

        $fsetIUC = wire('modules')->get("InputfieldFieldset");
        $fsetIUC->attr('name', 'InputfieldURLChecker');
        $fsetIUC->label = __('InputfieldURLChecker', __FILE__);
        $fsetIUC->showIf = 'enabledSubmodules=InputfieldURLChecker';
        $fsetIUC->collapsed = Inputfield::collapsedNever;

        // Mode
        $f = wire('modules')->get('InputfieldCheckboxes');
        $f->name = 'IUC_mode';
        $f->label = __('Mode', __FILE__);
        $f->columnWidth = 50;
        $f->collapsed = Inputfield::collapsedNever;
        $f->addOption('button', __('Button', 'IUC'));
        $f->addOption('ctrl-shift-click', __('Ctrl + Shift + Click', 'IUC'));
        $f->addOption('ctrl-shift-enter', __('Ctrl + Shift + Enter', 'IUC'));

        $f->attr('value', isset($data[$f->name]) ? $data[$f->name] : $dataIUC[$f->name]);

        $fsetIUC->add($f);

        // Mode - button
        $f = wire('modules')->get('InputfieldRadios');
        $f->name = 'IUC_button_position';
        $f->label = __('Button position', __FILE__);
        $f->collapsed = Inputfield::collapsedNever;
        $f->columnWidth = 50;
        $f->addOption('button-left', __('Left side of the field', 'IUC'));
        $f->addOption('button-right', __('Right side of the field', 'IUC'));
        $f->showIf = 'IUC_mode=button';
        $f->requiredIf = 'IUC_mode=button';

        $f->attr('value', isset($data[$f->name]) ? $data[$f->name] : $dataIUC[$f->name]);

        $fsetIUC->add($f);

        // Target
        $f = wire('modules')->get('InputfieldRadios');
        $f->name = 'IUC_target';
        $f->label = __('Open URL in...', __FILE__);
//        $f->notes     = __('Iframe mode fails if the target website does not allow iframe embed.', __FILE__);
        $f->collapsed = Inputfield::collapsedNever;
        $f->addOption('pw-blank', __('new tab', __FILE__));
        $f->addOption('pw-panel', __('panel', __FILE__));
        $f->addOption('pw-modal', __('modal', __FILE__));

        $f->attr('value', isset($data[$f->name]) ? $data[$f->name] : $dataIUC[$f->name]);

        $fsetIUC->add($f);

        $f = wire('modules')->get('InputfieldCheckbox');
        $f->name = 'IUC_force_http';
        $f->label = __('Force HTTP prefix', __FILE__);
        $f->collapsed = Inputfield::collapsedNever;

        $f->attr('value', isset($data[$f->name]) ? $data[$f->name] : $dataIUC[$f->name]);

        $f->checked = ($f->value == 1) ? 'checked' : $data[$f->name];


        $fsetIUC->add($f);

        // Enabled templates
        $f = wire('modules')->get('InputfieldAsmSelect');
        $f->name = 'IUC_enabled_templates';
        $f->label = __('Enabled templates', __FILE__);
        $f->attr('data-asm-placeholder', __('Add templates...', __FILE__));
        $f->collapsed = Inputfield::collapsedNever;
        $f->columnWidth = 50;

        foreach (wire('templates') as $t) {
            $f->addOption($t->name, self::getFormattedOptionName($t));
        }

        $f->attr('value', isset($data[$f->name]) ? $data[$f->name] : $dataIUC[$f->name]);

        $fsetIUC->add($f);


        // Enabled fields asmSelect
        $url_fields = wire('fields')->find('type=FieldtypeURL');

        // add asm select only if there is any URL type field

//        bd(count($url_fields));

        if (count($url_fields) > 0) {

            $f = wire('modules')->get('InputfieldAsmSelect');
            $f->name = 'IUC_enabled_fields';
            $f->label = __('Enabled fields', __FILE__);
            $f->collapsed = Inputfield::collapsedNever;
            $f->columnWidth = 50;

            foreach ($url_fields as $url_field) {
                $f->addOption($url_field->name, self::getFormattedOptionName($url_field));
            }

            $f->attr('data-asm-placeholder', __('Add fields...', __FILE__));

            $f->attr('value', isset($data[$f->name]) ? $data[$f->name] : $dataIUC[$f->name]);

        } else {

            // add info that no URL type fields are available
            $f = wire('modules')->get('InputfieldMarkup');
            $f->name = 'no_url_fields';
            $f->label = __('Enabled fields', __FILE__);
            // doesn't work
            // $f->collapsed = Inputfield::collapsedNever;
            $f->markupText = __('There is no URL field available', __FILE__);
        }

        $fsetIUC->add($f);

        $fset->add($fsetIUC);

        // LongClickDuration ----------------------------------------------- //

        $f = wire('modules')->get("InputfieldText");
        $f->attr('name', 'LongClickDuration');
        $f->description = __('', __FILE__);
        $f->notes = __('', __FILE__);
        $f->showIf = 'enabledSubmodules=LongClickDuration';
        $f->attr('style', 'width: 100px;');
        $f->collapsed = Inputfield::collapsedNever;

        $f->attr('value', (isset($data['LongClickDuration']) && (int)$data['LongClickDuration'] >= $defaultData['LongClickDuration']) ? $data['LongClickDuration'] : $defaultData['LongClickDuration']);

        $fset->add($f);

        // ModuleTweaks ----------------------------------------------- //

        $f = wire('modules')->get("InputfieldCheckboxes");
        $f->attr('name', 'ModuleTweaks');
        $f->showIf = 'enabledSubmodules=ModuleTweaks';
        $f->collapsed = Inputfield::collapsedNever;
        $f->description = __('', __FILE__);
        $f->notes = __('', __FILE__);

        $f->addOption('compactModuleList', __('Compact module list', __FILE__));
        $f->addOption('loadCollapsedModuleInfos', __('Load module info fields collapsed', __FILE__));

        if ($data['ModuleTweaks']) {
            $f->attr('value', $data['ModuleTweaks']);
        }

        $fset->add($f);

        // PageListThumbs ----------------------------------------------- //

        $fsetPageListThumbs = wire('modules')->get("InputfieldFieldset");
        $fsetPageListThumbs->attr('name', 'PageListThumbs');
        $fsetPageListThumbs->label = __('PageListThumbs', __FILE__);
        $fsetPageListThumbs->showIf = 'enabledSubmodules=PageListThumbs';
        $fsetPageListThumbs->collapsed = Inputfield::collapsedNever;


        $f = wire('modules')->get("InputfieldRadios");
        $f->attr('name', 'PageListThumbStyle');
        $f->label = __('Thumbnail style', __FILE__);
        $f->collapsed = Inputfield::collapsedNever;

        $f->addOption('default', __('default', __FILE__));
        $f->addOption('square', __('square', __FILE__));
        $f->addOption('circle', __('circle', __FILE__));

        if (isset($data['PageListThumbStyle'])) {
            $f->attr('value', $data['PageListThumbStyle']);
        } else {
            $f->attr('value', $data['PageListThumbs']['PageListThumbStyle']);
        }

        $fsetPageListThumbs->add($f);

        $f = wire('modules')->get("InputfieldTextarea");
        $f->attr('name', 'PageListThumbSettings');
        $f->label = __('Thumbnail source', __FILE__);
        $f->attr('placeholder', __('Enter field or field:selector pair(s)', __FILE__));
        $f->rows = 3;
        $f->collapsed = Inputfield::collapsedNever;

        if ($data['PageListThumbs'] && isset($data['PageListThumbSettings'])) {
            $f->attr('value', $data['PageListThumbSettings']);
        }

        $fsetPageListThumbs->add($f);

        $fset->add($fsetPageListThumbs);

        // PagePreviewLink ----------------------------------------------- //

        $f = wire('modules')->get("InputfieldRadios");
        $f->attr('name', 'PagePreviewLink');
        $f->label = __('PagePreviewLink', __FILE__);
        $f->showIf = 'enabledSubmodules=PagePreviewLink';
        $f->collapsed = Inputfield::collapsedNever;

        $f->addOption('pw-blank', __('Preview in new tab', __FILE__));
        $f->addOption('pw-panel', __('Preview in panel', __FILE__));
        $f->addOption('pw-modal', __('Preview in modal', __FILE__));

        if ($data['PagePreviewLink']) {
            $f->attr('value', $data['PagePreviewLink']);
        }

        $fset->add($f);

        // RenoTweaks ----------------------------------------------- //

        $f = wire('modules')->get("InputfieldCheckboxes");
        $f->attr('name', 'RenoTweaks');
        $f->label = __('RenoTweaks', __FILE__);
        $f->showIf = 'enabledSubmodules=RenoTweaks';
        $f->collapsed = Inputfield::collapsedNever;

        $f->addOption('stickyHeader', __('Sticky header', __FILE__));
        $f->addOption('stickyHeaderCompact', __('Compact header', __FILE__));
        $f->addOption('stickyCKEditorToolbar', __('Sticky CKEditor toolbar', __FILE__));
        $f->addOption('miniScrollbarSidebar', __('Use mini scrollbar for sidebar', __FILE__));
        $f->addOption('miniScrollbarMain', __('Use mini scrollbar for main content', __FILE__));
        $f->addOption('stickySidebar', __('Sticky sidebar', __FILE__));
        $f->addOption('autoHideSidebar', __('Autohide sidebar', __FILE__));
        $f->addOption('oneLineSidebarSubmenus', __('One-line sidebar submenus (only with autoHideSidebar)', __FILE__));
        $f->addOption('alwaysVisibleSidebarItems', __('Always show sidebar items (disable accordion)', __FILE__));
        $f->addOption('singleClickSidebarHeaders', __('Single click navigation of sidebar headers', __FILE__));
        $f->addOption('hideSidebarQuickLinks', __('Hide sidebar quick links (flash icons)', __FILE__));
        $f->addOption('compactPageList', __('Set narrow pagelist items', __FILE__));
        $f->addOption('alwaysShowSearch', __('Always show search field', __FILE__));
        $f->addOption('headButtonNextToTitle', __('Place header button next to the main title', __FILE__));
        $f->addOption('closeNoticeButtonToLeft', __('Move notice close buttons to the left', __FILE__));

        if ($data['RenoTweaks']) {
            $f->attr('value', $data['RenoTweaks']);
        }

        $fset->add($f);

        // Tooltips ----------------------------------------------- //

        $f = wire('modules')->get("InputfieldCheckboxes");
        $f->attr('name', 'Tooltips');
        $f->label = __('Tooltips', __FILE__);
        $f->showIf = 'enabledSubmodules=Tooltips';
        $f->collapsed = Inputfield::collapsedNever;
        $f->description = __('', __FILE__);
        $f->notes = __('', __FILE__);

        $f->addOption('superuseronly', __('Only for SuperUsers', __FILE__));
        $f->addOption('description', __('Enable for field descriptions', __FILE__));
        $f->addOption('notes', __('Enable for field notes', __FILE__));
        $f->addOption('overlayStyle', __('Use overlay style', __FILE__));

        if ($data['Tooltips']) {
            $f->attr('value', $data['Tooltips']);
        }

        $fset->add($f);

        $wrapper->add($fset);

        return $wrapper;
    }
}
